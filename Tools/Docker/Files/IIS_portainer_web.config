<configuration>
  <system.webServer>
    <!--
    PREREQUISITES:
      1. Install URL Rewrite Module 2.1:
         https://www.iis.net/downloads/microsoft/url-rewrite
      2. Install Application Request Routing (ARR) 3.0:
         https://www.iis.net/downloads/microsoft/application-request-routing

    ENABLE ARR PROXYING:
      By default ARR is installed but proxying is disabled.
      In IIS Manager:
        1) Select the SERVER node (the top node in the tree).
        2) Open "Application Request Routing Cache".
        3) In the Actions pane, click "Server Proxy Settings…".
        4) Check "Enable proxy" (optionally also "Reverse rewrite host in response headers").
        5) Click Apply.

    PRESERVE HOST HEADER:
      If you do not preserve the host header, ARR will overwrite it
      with the host:port from your <action> URL, which can break CORS,
      WebSockets, or services that check the Host/origin.
      To preserve the client’s Host header:
      In IIS Manager:
        1) Select the SERVER node.
        2) Open "Application Request Routing Cache".
        3) Click "Configuration Editor".
        4) In the Section field enter: system.webServer/proxy
        5) Set preserveHostHeader to True.
        6) Click Apply.

    DEBUGGING: Capture raw HTTP inside your container
      1) Restart your podman/docker container with NET_RAW and NET_ADMIN:
         podman run &#45;&#45;cap-add NET_RAW &#45;&#45;cap-add NET_ADMIN …
      2) From the host:
         podman exec -it -u 0 n8n /bin/sh
      3) Inside the container, install tcpdump:
         apk update && apk add tcpdump
      4) Run tcpdump against port 9000:
         tcpdump -i any -A 'dst port 9000'
    -->
    <rewrite>
      <rules>
        <rule name="portainer-reverse-proxy" stopProcessing="true">
          <match url="(.*)" />
          <!--<conditions>
            <add input="{HTTP_HOST}" pattern="^portainer\.example\.com$" />
          </conditions>-->
          <action
            type="Rewrite"
            url="http://127.0.0.1:9000/{R:1}"
            appendQueryString="true"
          />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>