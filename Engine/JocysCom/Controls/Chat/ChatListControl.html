<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>Messages</title>
	<!-- include marked -->
	<!-- include Prism's JS -->
	<link href="ChatListControl/prism.css" rel="stylesheet" />
	<script src="ChatListControl/core.min.js" defer="defer"></script>
	<script src="ChatListControl/marked.min.js" defer="defer"></script>
	<script src="ChatListControl/prism.js" defer="defer"></script>
	<style>
		/*em: Unit relative to the font-size of the parent element.
			1em is equal to the font size of the parent element, so if the parent's font-size is 16px, 1em would be 16px. */

		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
			font-family: 'Segoe UI', Arial, sans-serif;
			background-color: white;
			font-size: small;
		}

		/* Information (system message) */
		.color-Information {
			background-color: #f0f0f0;
		}

		/* Question (system message) */
		.color-Question {
			background-color: #d4f1d4;
		}

		/* Warning (system message) */
		.color-Warning {
			background-color: #fef9d9;
		}

		/* Error (system message) */
		.color-Error {
			background-color: #ffd6d6;
		}

		/* In (messages from other person) */
		.color-In {
			background-color: #f7f9fc;
		}

		/* Out (my messages) */
		.color-Out {
			background-color: #d1e6ff;
		}

		.chat-log {
		}

		.chat-container {
			padding: 0.5em 0 0.5em 0;
			display: flex;
			align-items: flex-start;
		}

		.chat-user {
			min-width: 2em;
			width: 2em;
			height: 2em;
			margin: 0.5em;
		}

		.icon-Information {
			background: url('ChatListControl/IconInformation.svg') no-repeat transparent;
			background-size: contain;
		}

		.icon-Question {
			background: url('ChatListControl/IconQuestion.svg') no-repeat transparent;
			background-size: contain;
		}

		.icon-Warning {
			background: url('ChatListControl/IconWarning.svg') no-repeat transparent;
			background-size: contain;
		}

		.icon-Error {
			background: url('ChatListControl/IconError.svg') no-repeat transparent;
			background-size: contain;
		}

		.icon-Out {
			background: url('ChatListControl/IconOut.svg') no-repeat transparent;
			background-size: contain;
		}

		.icon-In {
			background: url('ChatListControl/IconIn.svg') no-repeat transparent;
			background-size: contain;
		}

		.chat-message {
			/*padding: 0.5em 1em 1em 1em;*/ /* round corners */
			padding: 0.5em 1em 0 0; /* square corners */
			color: black;
			box-sizing: border-box;
			border-radius: 1em;
			flex-grow: 1;
			margin-right: 1em;
		}

		.chat-message-head {
			display: flex;
			align-items: center;
		}

		.chat-message-body {
			margin-top: 0.5em;
		}

		.chat-message-data {
		}

		.chat-date {
			opacity: 0.25;
		}

		.chat-button {
			cursor: pointer;
			color: white;
			opacity: 0.20;
			border: none;
			padding: 0.25em 0.5em;
			border-radius: 0.5em;
			background: linear-gradient(to bottom, #00aeec, #008adc);
			transition: opacity 0.3s ease;
			font-size: x-small;
			margin-left: 0.5em;
		}

			.chat-button:hover {
				opacity: 0.8;
				outline: none;
			}

			.chat-button.clicked {
				background: linear-gradient(to bottom, #00ff00, #008000);
			}

		code {
			font-family: 'Cascadia Mono', 'Consolas', default;
			font-size: small;
			background-color: rgba(0, 0, 0, 0.05);
			padding-left: 0.1em;
			padding-right: 0.1em;
		}

		pre code[class*="language-"] {
			font-family: 'Cascadia Mono', 'Consolas', default;
			font-size: x-small;
		}

		p {
			margin-top: 0.5em;
			margin-bottom: 0.5em;
			margin-block-start: 0.5em;
			margin-block-end: 0.5em;
		}
	</style>
	<style>

		.expandable-button-visible {
			opacity: 1.0 !important;
		}

		.expandable-button {
			cursor: pointer;
			color: black;
			opacity: 0.50;
			border: none;
			padding: 0.25em 0.5em;
			border-radius: 0.5em;
			background: linear-gradient(to bottom, #ffffff, #f0f0f0);
			transition: opacity 0.3s ease;
			font-size: x-small;
			margin-left: 0.5em;
		}

			.expandable-button:hover {
				/* opacity: 1.0;  */
				outline: none;
			}

			.expandable-button.clicked {
				/* background: linear-gradient(to bottom, #00ff00, #008000); */
			}


		.expandable-box {
			border-radius: 0.5em;
			overflow: hidden;
			border: 0 solid rgba(0, 0, 0, 0.2);
			display: inline-block;
			margin: 0 auto 2px auto;
			background: #ffffff;
		}

		.expandable-head {
			background-color: rgba(209, 230, 255, 0.4);
			cursor: pointer;
			padding: 0.25em 0.5em;
		}

		.expandable-head-text {
		}

		.expandable-head-indicator {
		}

		.expandable-body {
			padding-bottom: 0;
			width: 100%;
		}

		.expandable-instructions {
			padding: 0.25em 0.5em;
		}

			.expandable-instructions p {
				padding: 0;
				margin: 0;
			}

			.expandable-instructions pre {
				padding: 0;
				margin: 0;
			}

		.expandable-data {
			padding: 0.25em 0.5em;
			max-height: 1024px;
			overflow: auto;
		}

			.expandable-data p {
				padding: 0;
				margin: 0;
			}

			.expandable-data pre {
				padding: 0;
				margin: 0;
			}
	</style>
	<script defer="defer">

		var idPrefix = "message_";

		var messageType = ["Information", "Question", "Warning", "Error", "In", "Out"];

		const MessageType = {
			Information: 0,
			Question: 1,
			Warning: 2,
			Error: 3,
			In: 4,
			Out: 5,
		}

		const AttachmentType = {
			None: 0,
			Clipboard: 1,
			Selection: 2,
			ActiveDocument: 4,
			SelectedDocuments: 8,
			ActiveProject: 16,
			SelectedProject: 32,
			Solution: 64,
			SelectedError: 128,
			ChatHistory: 256,
		}

		function enumToString(value, enumObject) {
			for (let key in enumObject) {
				if (enumObject[key] === value) {
					return key;
				}
			}
			return null;
		}

		function InsertMessage(message, autoScroll) {
			var scroll = IsScrollOnTheBottom();
			var chatLog = document.getElementById('chatLog');
			var messageTemplate = document.getElementById('messageTemplate').innerHTML;
			// Convert markdown code to HTML.
			var body = "" + message.Body;
			// According to the Markdown Guide, in order to force a new line, you need to add 2 spaces at the end of the line, followed by the return key.
			// https://markdown-guide.readthedocs.io/en/latest/basics.html#line-return
			//var rx = new RegExp("([^ ])([ ]{0,1})(\\r?\\n)", "g");
			//body = body.replace(rx, "$1  $3");
			// Add support for markdown.
			var spacesRx = new RegExp("[\r\n\s]+$", "g")
			body = body.replace(spacesRx, "");
			// Make sure characters like `<` or `>` are not treated as HTML element characters.
			body = ConvertForDisplayAsHtml(body);
			body = marked.parse(body);
			// Trim all space from the end.
			body = body.replace(spacesRx, "");
			// Make sure that multiple spaces are preserved.
			//if (message.Type == MessageType.Out)
			//	body = "<div style=\"white-space: pre;\">" + body + "</div>";
			var newMessageInstructionsHTML = "";

			var buttons = "";
			// If body AI instructions supplied then...
			if ((message.BodyInstructions) && ("" + message.BodyInstructions).length > 0) {
				var instructions = message.BodyInstructions;
				// Make sure characters like `<` or `>` are not treated as HTML element characters.
				instructions = ConvertForDisplayAsHtml(instructions);
				instructions = marked.parse(instructions);
				var box = AddAttachmentBox(message.Id + "_instructions", "Instructions", instructions, "");
				buttons += box.buttonHTML;
				newMessageInstructionsHTML = box.panelHTML;
			}

			var attachments = message.Attachments;
			var data = "";

			if (Array.isArray(attachments)) {
				for (var i = 0; i < attachments.length; i++) {
					var a = attachments[i];
					var aData = "";
					// If data use markdown then...
					// Example: ```{Language}\r\n{Data}\r\n```
					if (a.IsMarkdown) {
						aData = (a.Data) ? a.Data : "";
						aData = ConvertForDisplayAsHtml(aData);
						aData = marked.parse(aData);
					} else {
						// Wrap into plain text element.
						var pre = document.createElement('pre');
						pre.innerText = a.Data;
						aData = pre.outerHTML;
					}
					var aInstructions = "";
					// If instructions supplied then...
					if ((a.Instructions) && ("" + a.Instructions).length > 0) {
						aInstructions = a.Instructions;
						aInstructions = ConvertForDisplayAsHtml(aInstructions);
						aInstructions = aInstructions + "</ br>";
					}
					var box = AddAttachmentBox(message.Id + "_" + i, a.Title, aInstructions, aData);
					buttons += box.buttonHTML;
					data += "\r\n\r\n" + box.panelHTML;
				}
			}

			// Replace all placeholders with actual values from the message.
			var newMessageHTML = messageTemplate
				.replace(/{Type}/g, messageType[message.Type])
				.replace(/{Id}/g, idPrefix + message.Id)
				.replace(/{User}/g, message.User)
				.replace(/{Date}/g, FormatDateTime(message.Date))
				.replace(/{Body}/g, newMessageInstructionsHTML + body)
				.replace(/{Data}/g, data)
				.replace(/{Buttons}/g, buttons);

			// Create a new div element and set its innerHTML to the newly created message.
			var newMessage = document.createElement('div');
			newMessage.innerHTML = newMessageHTML;
			chatLog.appendChild(newMessage);
			// Scroll to the bottom of the chatLog div.
			if (autoScroll && scroll)
				ScrollToBottom();
		}

		function AddAttachmentBox(attachmentId, title, instructions, data) {
			var showInstructions = (instructions) && instructions.trim().length > 0;
			var showData = (data) && data.trim().length > 0;
			// Return if nothing to show.
			if (!showInstructions && !showData)
				return { buttonHTML: "", panelHTML: "" };
			var panelHTML = document.getElementById("expandableBoxPanelTemplate").innerHTML;
			panelHTML = panelHTML
				.replace(/{Id}/g, attachmentId)
				.replace(/{Title}/g, title)
				.replace(/{Instructions}/g, instructions)
				.replace(/{InstructionsStyle}/g, showInstructions ? "" : "display: none;")
				.replace(/{Data}/g, data)
				.replace(/{DataStyle}/g, showData ? "" : "display: none;");
			var buttonHTML = document.getElementById("expandableBoxButtonTemplate").innerHTML;
			buttonHTML = buttonHTML
				.replace(/{Id}/g, attachmentId)
				.replace(/{Title}/g, title)
			return { buttonHTML: buttonHTML, panelHTML: panelHTML };
		}

		// attachmentId = "{messageId}_{attachmentIndex}".
		function AttachmentButton_Click(sender, attachmentId) {
			sender.classList.add('clicked');
			setTimeout(function () {
				sender.classList.remove('clicked');
			}, 500);
			var element = document.getElementById(attachmentId + "_panel");
			var button = document.getElementById(attachmentId + "_button");
			// Toggle visibility
			if (element.style.display === "none") {
				element.style.display = "inline-block";
				button.classList.add('expandable-button-visible');
			} else {
				element.style.display = "none";
				button.classList.remove('expandable-button-visible');
			}
		}

		// Prepare text for markdown and display as HTML.
		function ConvertForDisplayAsHtml(text) {
			// Split the text by triple quotes ('```')
			var blocks = text.split('```');
			for (let i = 0; i < blocks.length; i++) {
				// Only process the text not within triple quotes
				if (i % 2 === 0) {
					var block = blocks[i];
					var subBlocks = block.split('`');
					for (let s = 0; s < subBlocks.length; s++) {
						// Only process the text not within single quotes
						if (s % 2 === 0) {
							subBlocks[s] = EscapeHtml(subBlocks[s]);
							var lines = subBlocks[s].replace(/\r?\n/g, "\n").split("\n");
							var lBlock = "";
							for (let l = 0; l < lines.length; l++)
								lBlock += lines[l] + (l > 0 && l < lines.length - 1 ? "<br />\r\n" : "\r\n");
							subBlocks[s] = lBlock;
						}
					}
					blocks[i] = subBlocks.join('`');
				}
			}
			var processedText = blocks.join('```');
			return processedText;
		}

		function EscapeHtml(unsafe) {
			return unsafe
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#039;");
		}

		function DeleteMessage(messageId) {
			var el = document.getElementById(idPrefix + messageId).parentElement;
			el.parentElement.removeChild(el);
		}

		function DeleteMessages() {
			var chatLog = document.getElementById('chatLog');
			chatLog.innerHTML = "";
		}

		function SetScrollPosition(position) {
			window.scrollTo(0, position);
		}

		function GetScrollPosition() {
			// Get current scroll position
			var scrollTop = (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
			return scrollTop;
		}

		function IsScrollOnTheBottom() {
			var scrollTop = (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
			var windowHeight = "innerHeight" in window ? window.innerHeight : document.documentElement.offsetHeight;
			var body = document.body, html = document.documentElement;
			var pageHeight = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
			var delta = Math.ceil(windowHeight + scrollTop);
			// if the sum of the height of the inner window and the scroll position is greater than or equal to the total scroll height of the page
			return pageHeight <= delta;
		}

		function ScrollToBottom() {
			window.setTimeout(function () {
				window.scroll(0, document.body.scrollHeight);
			}, 0);
		}

		function MessageAction(button, messageId, action) {
			button.classList.add('clicked');
			setTimeout(function () {
				button.classList.remove('clicked');
			}, 500);
			var id = messageId.substr(idPrefix.length);
			window.external.MessageAction(id, action);
		}

		function FormatDateTime(datetime) {
			var currentDate = new Date();
			var targetDate = new Date(datetime);
			var isToday =
				currentDate.getDate() === targetDate.getDate() &&
				currentDate.getMonth() === targetDate.getMonth() &&
				currentDate.getFullYear() === targetDate.getFullYear();
			return isToday
				? targetDate.toLocaleTimeString([], { timeStyle: 'short' })
				: targetDate.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
		}

		function SetSettings(settings) {
			if (!settings)
				return;
			var position = settings.ScrollPosition;
			// Check if position is a valid number and larger than 0
			if (!isNaN(position) && position > 0)
				SetScrollPosition(position);
		}

		function GetSettings() {
			var position = GetScrollPosition();
			var settings = {
				"ScrollPosition": position,
			};
			return JSON.stringify(settings);
		}

		// Keep scrool on the bottom when resizing.
		let resizeTimeout;
		let wasScrolledToBottom;
		window.addEventListener('resize', function () {
			// Clear the timeout if it exists
			if (resizeTimeout)
				clearTimeout(resizeTimeout);
			else {
				wasScrolledToBottom = IsScrollOnTheBottom();
				//console.log("Start: " + wasScrolledToBottom);
			}
			// Set a timeout to run the function after a short delay
			resizeTimeout = setTimeout(function () {
				// Check the scroll position status when resizing ends
				//console.log("End: " + wasScrolledToBottom);
				if (wasScrolledToBottom) {
					ScrollToBottom();
				}
				resizeTimeout = null;
			}, 100);
		});

		window.onload = function () {

			window.external.MessageAction("0", "Loaded");

			// Update rendered to convert language to lowercase for Prism.js.
			var renderer = new marked.Renderer();
			var originalCodeFunction = renderer.code;
			renderer.code = function (code, lang, escaped) {
				lang = lang ? lang.toLowerCase() : undefined;
				var html = originalCodeFunction.call(this, code, lang, escaped);
				return html;
			};

			marked.setOptions({
				// Enable for prism.
				highlight: function (code, lang) {
					return Prism.languages[lang] ? Prism.highlight(code, Prism.languages[lang], lang) : code;
				},

				renderer: renderer
			});

			// The code will only run if the file is opened locally.
			if (window.location.href.indexOf("file://") == -1)
				return;
			for (var i = 0; i < 6; i++) {
				var message = {
					Type: i % 6,
					Id: idPrefix + i,
					User: i % 2 == 1 ? "UserIn" : "UserOut",
					Date: new Date().setMinutes(i),
					Body: messageType[i % 6] + "(" + i + ")" + " messsage. ` test <> test ` \r\n",
					BodyInstructions: "Instructions included at the start of every message.",
					DataType: AttachmentType.Selection,
					Data:
						"```csharp\r\n" +
						"var x = 1 + y;\r\n" +
						"```\r\n" +
						"\r\n" +
						"```JavaScript\r\n" +
						"var x = 1 + y;\r\n" +
						"```\r\n" +
						"\r\n" +
						"```css\r\n" +
						"p { color: red }\r\n" +
						"```\r\n",
					Attachments: [
						{
							Title: "Data to Process",
							Instructions: "aaa",
							Type: AttachmentType.Selection,
							Data: "```csharp\r\nvar x = 1 + y;\r\n```",
						}
					]
				}
				InsertMessage(message);
			}
		}

	</script>
</head>
<body>
	<div style="display: none" id="expandableBoxButtonTemplate">
		<button id="{Id}_button" class="expandable-button" onclick="AttachmentButton_Click(this, '{Id}')">
			<span>{Title}</span>
		</button>
	</div>
	<div id="expandableBoxPanelTemplate">
		<div class="expandable-box" id="{Id}_panel" style="display: none;">
			<div class="expandable-head">
				<span class="expandable-head-text">{Title}</span>
				<span class="expandable-head-indicator" style="display: none;">…</span>
			</div>
			<div class="expandable-body">
				<div class="expandable-instructions" style="{InstructionsStyle}">
					{Instructions}
				</div>
				<div class="expandable-data" style="{DataStyle}">
					{Data}
				</div>
			</div>
		</div>
	</div>
	<div style="display: none" id="messageTemplate">
		<div class="chat-container color-{Type}" id="{Id}">
			<div class="chat-user icon-{Type}" aria-label="{User}"></div>
			<div class="chat-message color-{Type}">
				<div class="chat-message-head">
					<span class="chat-date">{Date}</span>
					<button class="chat-button" onclick="MessageAction(this, '{Id}', 'Use')">Use</button>
					<button class="chat-button" onclick="MessageAction(this, '{Id}', 'Remove')">Remove</button>
					<button class="chat-button" onclick="MessageAction(this, '{Id}', 'Copy')">Copy</button>
					{Buttons}
				</div>
				<div class="chat-message-body">{Body}</div>
				<div class="chat-message-data">{Data}</div>
			</div>
		</div>
	</div>
	<!-- Messages would go here -->
	<div id="chatLog" class="chat-log">
	</div>
</body>
</html>


